{
    "info": {
      "name": "Entelequia Delivery API (MVP)",
      "_postman_id": "6f0e2a19-7b8c-4a0b-9f7a-raw-raw-raw",
      "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
      "description": "Colección para probar Auth, Orders, Shipments, Imports (CSV), Locations y Realtime (SSE) en local."
    },
    "variable": [
      { "key": "base_url", "value": "http://localhost:3001" },
      { "key": "token", "value": "" }
    ],
    "item": [
      {
        "name": "Auth",
        "item": [
          {
            "name": "Login",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const json = pm.response.json();",
                    "if (json.token) {",
                    "  pm.collectionVariables.set('token', json.token);",
                    "  pm.environment.set('token', json.token);",
                    "  console.log('Token guardado en collection/env');",
                    "}"
                  ],
                  "type": "text/javascript"
                }
              }
            ],
            "request": {
              "method": "POST",
              "header": [{ "key": "Content-Type", "value": "application/json" }],
              "url": { "raw": "{{base_url}}/auth/login", "host": ["{{base_url}}"], "path": ["auth", "login"] },
              "body": {
                "mode": "raw",
                "raw": "{\n  \"email\": \"admin@entelequia.local\",\n  \"password\": \"admin1234\"\n}"
              },
              "description": "Devuelve { token, role } y guarda el token en variables."
            },
            "response": []
          }
        ]
      },
      {
        "name": "Orders",
        "item": [
          {
            "name": "List Orders",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/orders", "host": ["{{base_url}}"], "path": ["orders"] }
            },
            "response": []
          },
          {
            "name": "Create Order",
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/orders", "host": ["{{base_url}}"], "path": ["orders"] },
              "body": {
                "mode": "raw",
                "raw": "{\n  \"external_ref\": \"POSTMAN-ORDER-001\",\n  \"amount_cents\": 12345,\n  \"currency\": \"ARS\",\n  \"channel\": \"web\",\n  \"status\": \"received\",\n  \"metadata\": {\"source\":\"postman\"}\n}"
              }
            },
            "response": []
          },
          {
            "name": "Get Order by ID",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/orders/:id", "host": ["{{base_url}}"], "path": ["orders", ":id"] },
              "description": "Reemplaza :id por el UUID."
            },
            "response": []
          },
          {
            "name": "Update Order (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/orders/:id", "host": ["{{base_url}}"], "path": ["orders", ":id"] },
              "body": {
                "mode": "raw",
                "raw": "{\n  \"status\": \"preparing\",\n  \"metadata\": {\"note\":\"patched from postman\"}\n}"
              }
            },
            "response": []
          }
        ]
      },
      {
        "name": "Shipments",
        "item": [
          {
            "name": "List Shipments",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/shipments", "host": ["{{base_url}}"], "path": ["shipments"] }
            },
            "response": []
          },
          {
            "name": "Create Shipment",
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/shipments", "host": ["{{base_url}}"], "path": ["shipments"] },
              "body": {
                "mode": "raw",
                "raw": "{\n  \"order_id\": \"REPLACE_WITH_ORDER_UUID\",\n  \"delivery_method\": \"courier\"\n}"
              }
            },
            "response": []
          },
          {
            "name": "Get Shipment by ID (Serializer)",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/shipments/:id", "host": ["{{base_url}}"], "path": ["shipments", ":id"] },
              "description": "Devuelve { id, order_id, status, delivery_method, qr_token, eta, events[] } según ShipmentSerializer."
            },
            "response": []
          },
          {
            "name": "Update Shipment (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/shipments/:id", "host": ["{{base_url}}"], "path": ["shipments", ":id"] },
              "body": { "mode": "raw", "raw": "{\n  \"status\": \"out_for_delivery\"\n}" }
            },
            "response": []
          },
          {
            "name": "Assign Courier",
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/shipments/:id/assign", "host": ["{{base_url}}"], "path": ["shipments", ":id", "assign"] },
              "body": { "mode": "raw", "raw": "{\n  \"courier_id\": \"REPLACE_WITH_COURIER_UUID\"\n}" }
            },
            "response": []
          },
          {
            "name": "Regenerate OTP/QR",
            "request": {
              "method": "POST",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/shipments/:id/otp", "host": ["{{base_url}}"], "path": ["shipments", ":id", "otp"] }
            },
            "response": []
          }
        ]
      },
      {
        "name": "Imports (CSV)",
        "item": [
          {
            "name": "Dry Run (csv_exact)",
            "request": {
              "method": "POST",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/imports/orders/dry_run", "host": ["{{base_url}}"], "path": ["imports", "orders", "dry_run"] },
              "body": {
                "mode": "formdata",
                "formdata": [
                  { "key": "format", "type": "text", "value": "csv_exact" },
                  { "key": "file", "type": "file", "src": [] }
                ]
              },
              "description": "Adjuntá un CSV con encabezados: Pedido #, Cliente, Fecha, Monto, Entrega, Estado."
            },
            "response": []
          },
          {
            "name": "Commit (csv_exact)",
            "request": {
              "method": "POST",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/imports/orders/commit", "host": ["{{base_url}}"], "path": ["imports", "orders", "commit"] },
              "body": {
                "mode": "formdata",
                "formdata": [
                  { "key": "format", "type": "text", "value": "csv_exact" },
                  { "key": "file", "type": "file", "src": [] }
                ]
              }
            },
            "response": []
          }
        ]
      },
      {
        "name": "Locations",
        "item": [
          {
            "name": "Create Location (idempotent)",
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/locations", "host": ["{{base_url}}"], "path": ["locations"] },
              "body": {
                "mode": "raw",
                "raw": "{\n  \"courier_id\": \"REPLACE_WITH_COURIER_UUID\",\n  \"ts\": \"2025-08-10T12:00:00Z\",\n  \"lat\": -34.6037,\n  \"lon\": -58.3816,\n  \"accuracy\": 10,\n  \"speed\": 2.1,\n  \"battery\": 88,\n  \"app_version\": \"0.1.0\"\n}"
              }
            },
            "response": []
          }
        ]
      },
      {
        "name": "Realtime (SSE)",
        "item": [
          {
            "name": "Stream (SSE)",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/realtime/stream", "host": ["{{base_url}}"], "path": ["realtime", "stream"] },
              "description": "Postman no renderiza bien SSE; preferible curl o el panel (EventSource)."
            },
            "response": []
          }
        ]
      },
      {
        "name": "Proofs (Supabase)",
        "item": [
          {
            "name": "Admin: Get Bucket",
            "request": {
              "method": "GET",
              "header": [
                { "key": "Authorization", "value": "Bearer {{SUPABASE_SERVICE_KEY}}" },
                { "key": "apikey", "value": "{{SUPABASE_SERVICE_KEY}}" }
              ],
              "url": { "raw": "{{SUPABASE_URL}}/storage/v1/bucket/{{bucket_name}}", "host": ["{{SUPABASE_URL}}"], "path": ["storage","v1","bucket","{{bucket_name}}"] },
              "description": "Checks if the bucket exists in Supabase. Requires service role key."
            },
            "response": []
          },
          {
            "name": "Admin: Create Bucket",
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{SUPABASE_SERVICE_KEY}}" },
                { "key": "apikey", "value": "{{SUPABASE_SERVICE_KEY}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{SUPABASE_URL}}/storage/v1/bucket", "host": ["{{SUPABASE_URL}}"], "path": ["storage","v1","bucket"] },
              "body": { "mode": "raw", "raw": "{\n  \"name\": \"{{bucket_name}}\",\n  \"public\": false\n}" },
              "description": "Creates the bucket if missing. Requires service role key."
            },
            "response": []
          },
          {
            "name": "Presign Upload",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "let json = null; try { json = pm.response.json(); } catch (e) {}",
                    "if (json && json.upload_url && json.key) {",
                    "  pm.collectionVariables.set('upload_url', json.upload_url);",
                    "  pm.collectionVariables.set('upload_key', json.key);",
                    "  pm.environment.set('upload_url', json.upload_url);",
                    "  pm.environment.set('upload_key', json.key);",
                    "  console.log('Saved upload_url and upload_key to collection and environment');",
                    "} else {",
                    "  console.log('Presign missing fields', pm.response.text());",
                    "}"
                  ],
                  "type": "text/javascript"
                }
              }
            ],
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/proofs/presign", "host": ["{{base_url}}"], "path": ["api", "v1", "proofs", "presign"] },
              "body": {
                "mode": "raw",
                "raw": "{\n  \"filename\": \"postman-upload.jpg\",\n  \"content_type\": \"{{upload_content_type}}\"\n}"
              },
              "description": "Gets a signed upload URL and key for direct upload to Supabase."
            },
            "response": []
          },
          {
            "name": "Upload via Signed URL (PUT binary)",
            "request": {
              "method": "PUT",
              "header": [
                { "key": "Content-Type", "value": "{{upload_content_type}}" },
                { "key": "x-upsert", "value": "true" }
              ],
              "url": { "raw": "{{upload_url}}", "host": ["{{upload_url}}"] },
              "body": {
                "mode": "binary",
                "binary": { "src": [] }
              },
              "description": "Choose a local file to upload; must match Content-Type."
            },
            "response": []
          },
          {
            "name": "Create Proof (link key to shipment)",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "let json = null; try { json = pm.response.json(); } catch (e) {}",
                    "if (json && json.proof_id) {",
                    "  pm.collectionVariables.set('proof_id', json.proof_id);",
                    "  pm.environment.set('proof_id', json.proof_id);",
                    "  console.log('Saved proof_id to collection and environment');",
                    "} else {",
                    "  console.log('Create proof missing proof_id', pm.response.text());",
                    "}"
                  ],
                  "type": "text/javascript"
                }
              }
            ],
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/proofs", "host": ["{{base_url}}"], "path": ["api", "v1", "proofs"] },
              "body": {
                "mode": "raw",
                "raw": "{\n  \"shipment_id\": \"{{shipment_id}}\",\n  \"key\": \"{{upload_key}}\",\n  \"lat\": -34.6037,\n  \"lon\": -58.3816,\n  \"method\": \"photo\"\n}"
              },
              "description": "Creates a Proof referencing the uploaded key."
            },
            "response": []
          },
          {
            "name": "Get Proof Signed Download URL",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "let json = null; try { json = pm.response.json(); } catch (e) {}",
                    "if (json && json.url) {",
                    "  pm.collectionVariables.set('signed_download_url', json.url);",
                    "  pm.environment.set('signed_download_url', json.url);",
                    "  console.log('Saved signed_download_url to collection and environment');",
                    "} else {",
                    "  console.log('No url in signed_url response', pm.response.text());",
                    "}"
                  ],
                  "type": "text/javascript"
                }
              }
            ],
            "request": {
              "method": "GET",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/proofs/{{proof_id}}/signed_url", "host": ["{{base_url}}"], "path": ["api", "v1", "proofs", "{{proof_id}}", "signed_url"] },
              "description": "Returns a temporary signed URL for downloading the proof."
            },
            "response": []
          },
          {
            "name": "Download via Signed URL",
            "request": {
              "method": "GET",
              "header": [],
              "url": { "raw": "{{signed_download_url}}", "host": ["{{signed_download_url}}"] },
              "description": "Fetch the file content using the signed URL."
            },
            "response": []
          }
        ]
      },
      {
        "name": "Routes",
        "item": [
          {
            "name": "List Routes",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": {
                "raw": "{{base_url}}/api/v1/routes?date={{service_date}}&courier_id={{courier_id}}&status={{route_status}}",
                "host": ["{{base_url}}"],
                "path": ["api","v1","routes"],
                "query": [
                  { "key": "date", "value": "{{service_date}}" },
                  { "key": "courier_id", "value": "{{courier_id}}" },
                  { "key": "status", "value": "{{route_status}}" }
                ]
              }
            },
            "response": []
          },
          {
            "name": "Create Route",
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/routes", "host": ["{{base_url}}"], "path": ["api","v1","routes"] },
              "body": { "mode": "raw", "raw": "{\n  \"route\": { \"service_date\": \"{{service_date}}\", \"courier_id\": \"{{courier_id}}\", \"status\": \"planned\" }\n}" }
            },
            "response": []
          },
          {
            "name": "Show Route",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}"] }
            },
            "response": []
          },
          {
            "name": "Update Route (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}"] },
              "body": { "mode": "raw", "raw": "{\n  \"route\": { \"status\": \"in_progress\" }\n}" }
            },
            "response": []
          },
          {
            "name": "Assign Courier (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/assign_courier", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","assign_courier"] },
              "body": { "mode": "raw", "raw": "{\n  \"courier_id\": \"{{courier_id}}\"\n}" }
            },
            "response": []
          },
          {
            "name": "Start Route (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/start", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","start"] }
            },
            "response": []
          },
          {
            "name": "Complete Route (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/complete", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","complete"] }
            },
            "response": []
          },
          {
            "name": "Stops: List",
            "request": {
              "method": "GET",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/stops", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","stops"] }
            },
            "response": []
          },
          {
            "name": "Stops: Create",
            "request": {
              "method": "POST",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/stops", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","stops"] },
              "body": { "mode": "raw", "raw": "{\n  \"stop\": { \"shipment_id\": \"{{shipment_id}}\", \"sequence\": 1 }\n}" }
            },
            "response": []
          },
          {
            "name": "Stops: Update (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/stops/{{stop_id}}", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","stops","{{stop_id}}"] },
              "body": { "mode": "raw", "raw": "{\n  \"stop\": { \"sequence\": 2 }\n}" }
            },
            "response": []
          },
          {
            "name": "Stops: Delete",
            "request": {
              "method": "DELETE",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/stops/{{stop_id}}", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","stops","{{stop_id}}"] }
            },
            "response": []
          },
          {
            "name": "Stops: Resequence (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/stops/resequence", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","stops","resequence"] },
              "body": { "mode": "raw", "raw": "{\n  \"order\": [\"{{stop_id}}\"]\n}" }
            },
            "response": []
          },
          {
            "name": "Stops: Complete (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/stops/{{stop_id}}/complete", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","stops","{{stop_id}}","complete"] }
            },
            "response": []
          },
          {
            "name": "Stops: Fail (PATCH)",
            "request": {
              "method": "PATCH",
              "header": [
                { "key": "Authorization", "value": "Bearer {{token}}" },
                { "key": "Content-Type", "value": "application/json" }
              ],
              "url": { "raw": "{{base_url}}/api/v1/routes/{{route_id}}/stops/{{stop_id}}/fail", "host": ["{{base_url}}"], "path": ["api","v1","routes","{{route_id}}","stops","{{stop_id}}","fail"] },
              "body": { "mode": "raw", "raw": "{\n  \"reason\": \"customer_absent\"\n}" }
            },
            "response": []
          }
        ]
      }
    ]
  }
  